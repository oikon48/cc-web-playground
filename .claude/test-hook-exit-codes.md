# ccusage Hook Exit Code Test Results

## テスト方法
1. `.claude/stop-hook-ccusage.sh`の最後に`exit 1`または`exit 2`を追加
2. 会話を終了する
3. 表示されるメッセージや動作を観察

## 予想される動作

### exit 0 (正常終了)
- hookは正常に実行される
- ccusageの統計が表示される
- エラーメッセージなし

### exit 1 (一般的なエラー)
- hookがエラーで終了
- 可能性1: エラーメッセージが表示されるが会話は終了する
- 可能性2: エラーは無視され、会話は通常通り終了する
- 可能性3: ユーザーにhookの失敗が通知される

### exit 2 (誤用エラー)
- exit 1と同様の動作が予想される
- シェルスクリプトの慣習では、exit 2は「誤用」を示すことが多い

## 実際のテスト結果

### exit 1の場合

**テスト日時**: 2025-10-30

**観察された動作**:
1. Stop hookは実行された（git-check hookからのフィードバックを受信）
2. ccusage hookの出力（統計情報）は**表示されなかった**
3. git-check hookは正常に実行され、フィードバックが表示された
4. 会話は正常に終了できた（exit 1で会話終了がブロックされることはない）

**結論**:
- `exit 1`で終了したhookの出力は抑制される可能性が高い
- 他のhookの実行には影響しない（git-check hookは正常に動作）
- Stop hookの失敗は会話終了をブロックしない

**推測される仕様**:
- Stop hookのexit codeが0以外の場合、そのhookの出力は表示されない
- 複数のhookがある場合、各hookは独立して実行される
- hookの失敗はユーザーに直接通知されない（出力が表示されないことで間接的に分かる）

### exit 2の場合

**テスト日時**: 2025-10-30

**観察された動作**:
1. hookのファイル名が表示された: `[.claude/stop-hook-ccusage.sh]`
2. メッセージ: `No stderr output` が表示された
3. ccusage hookの出力（統計情報）は**表示されなかった**（exit 1と同様）
4. 会話は正常に終了できた

**exit 1との違い**:
- **exit 1**: 何も表示されない（完全に抑制）
- **exit 2**: hookファイル名と "No stderr output" が表示される

**結論**:
- `exit 2`の場合、Claude Codeは明示的にhookの失敗を報告する
- "No stderr output"は、おそらくstderrからのエラーメッセージを期待していたが見つからなかった
- exit 1とexit 2で異なる処理がされている（exit 2の方が明示的）

## まとめ

### Claude Code の Stop Hook における exit code の動作

| Exit Code | 動作 | フィードバック表示 | 統計出力 |
|-----------|------|-------------------|---------|
| 0 (正常) | 正常実行 | なし（成功） | ✅ 表示される |
| 1 (エラー) | 失敗 | **表示されない** | ❌ 抑制される |
| 2 (誤用) | 失敗 | `[hookファイル名]: No stderr output` | ❌ 抑制される |

### 重要な発見

1. **exit 1 と exit 2 で動作が異なる**
   - exit 1: 完全に静かに失敗（何も表示されない）
   - exit 2: 失敗を明示的に報告（hookファイル名とメッセージを表示）

2. **stdoutの出力は抑制される**
   - exit code が0以外の場合、hookからのstdout出力は表示されない
   - これにより、ccusageの統計情報は表示されない

3. **会話終了への影響**
   - どのexit codeでも会話終了はブロックされない
   - Stop hookの失敗は致命的ではない

### 推奨事項

**実用上の注意**:
- ✅ hookは必ず`exit 0`で終了させる
- ❌ 非ゼロのexit codeでは期待する出力が表示されない
- ⚠️ エラー処理では、メッセージを表示してから`exit 0`するか、または`set -e`を使わない
- 💡 デバッグ時はstderrにメッセージを出力すると、exit 2で表示される可能性がある

## 注意点
- `set -euo pipefail`が設定されているため、スクリプト内でエラーが発生すると自動的に終了する
- hookが意図せず非ゼロで終了すると、ユーザーが期待する情報が表示されない
